worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Max file size (100MB)
    client_max_body_size 100m;
    proxy_max_temp_file_size 100m;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript
               application/xml application/xml+rss text/javascript image/svg+xml;

    # Proxy cache settings - include Accept header in cache key
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=thumbor_cache:100m
                     max_size=10g inactive=365d use_temp_path=off;

    # Origin mappings
    map $origin_prefix $origin_domain {
        default         "";
        interior        "interioricons.com";
        tina            "assets.tina.io";
        anandjoeltina   "assets.tina.io/3a743d97-a554-4b19-acc5-85219789c469";
        mobelaris       "old.mobelaris.com";
        shopify         "cdn.shopify.com";
        wp-content      "merakiweddingplanner.com/wp-content";
        uploads         "strapi.merakiweddingplanner.com/uploads";
    }

    # Detect best image format from Accept header
    # Priority: WebP > JPEG (AVIF disabled due to Pillow compatibility issues)
    map $http_accept $webp_suffix {
        default "";
        "~*image/webp" ":format(webp)";
    }

    # Upstream for Thumbor
    upstream thumbor {
        server thumbor:8888;
        keepalive 32;
    }

    server {
        listen 80;
        server_name _;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }

        # Favicon
        location = /favicon.ico {
            return 204;
            access_log off;
        }

        # Main image processing endpoint
        # URL format: /{transformations}/{origin_prefix}/{path}
        # Example: /w_1024,c_limit,q_auto/interior/cdn/shop/files/image.jpg
        location ~ ^/([^/]+)/([^/]+)/(.+)$ {
            set $transformations $1;
            set $origin_prefix $2;
            set $image_path $3;

            # Check if origin is valid
            if ($origin_domain = "") {
                return 404 "Unknown origin prefix: $origin_prefix";
            }

            # Parse transformations and build Thumbor URL
            set $thumbor_size "";
            set $thumbor_fit "";
            set $thumbor_filters "";
            set $width "";
            set $height "";

            # Extract width (w_XXX)
            if ($transformations ~ "w_([0-9]+)") {
                set $width $1;
            }

            # Extract height (h_XXX)
            if ($transformations ~ "h_([0-9]+)") {
                set $height $1;
            }

            # Build size string
            set $thumbor_size "${width}x${height}";

            # Handle cases where only width or height is specified
            if ($width = "") {
                set $thumbor_size "0x${height}";
            }
            if ($height = "") {
                set $thumbor_size "${width}x0";
            }
            if ($width = "") {
                set $width "0";
            }
            if ($height = "") {
                set $height "0";
            }

            # Check for c_limit (fit-in mode - don't upscale)
            set $thumbor_fit "";
            if ($transformations ~ "c_limit") {
                set $thumbor_fit "fit-in/";
            }

            # Extract quality (q_XXX or q_auto)
            set $quality "90";
            if ($transformations ~ "q_([0-9]+)") {
                set $quality $1;
            }

            # Build filters with format based on Accept header
            # $webp_suffix will be ":format(webp)" if browser supports WebP, empty otherwise
            set $thumbor_filters "filters:quality($quality)$webp_suffix";

            # Add no_upscale filter if c_limit is present
            if ($transformations ~ "c_limit") {
                set $thumbor_filters "filters:quality($quality):no_upscale()$webp_suffix";
            }

            # Build the full Thumbor URL
            # Format: /unsafe/{fit-in/}{WxH}/{filters}/https://{origin}/{path}
            set $thumbor_url "/unsafe/${thumbor_fit}${width}x${height}/${thumbor_filters}/https://${origin_domain}/${image_path}";

            # Proxy to Thumbor
            proxy_pass http://thumbor$thumbor_url;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Cache settings - include format in cache key via Vary
            proxy_cache thumbor_cache;
            proxy_cache_key "$scheme$request_method$host$request_uri$webp_suffix";
            proxy_cache_valid 200 365d;
            proxy_cache_valid 404 1m;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_lock on;
            proxy_cache_lock_timeout 5s;
            add_header X-Cache-Status $upstream_cache_status;

            # Long cache headers for browsers
            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header Vary "Accept";

            # Timeouts (extended for large files)
            proxy_connect_timeout 30s;
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;

            # Buffer settings (increased for large files)
            proxy_buffering on;
            proxy_buffer_size 256k;
            proxy_buffers 8 512k;
            proxy_busy_buffers_size 1m;
        }

        # Passthrough for direct Thumbor URLs (for debugging)
        location ~ ^/unsafe/ {
            proxy_pass http://thumbor;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;

            # Cache settings
            proxy_cache thumbor_cache;
            proxy_cache_valid 200 365d;
            add_header X-Cache-Status $upstream_cache_status;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # Root - return info
        location = / {
            return 200 "Thumbornary - Cloudinary-compatible image CDN\n\nUsage: /{transformations}/{origin}/{path}\n\nTransformations:\n  w_1024 - width\n  h_800 - height\n  c_limit - fit-in (don't upscale)\n  q_80 - quality\n\nOrigins: interior, tina, anandjoeltina, mobelaris, shopify, wp-content, uploads\n\nAuto WebP: Enabled (based on Accept header)\n";
            add_header Content-Type text/plain;
        }
    }
}
